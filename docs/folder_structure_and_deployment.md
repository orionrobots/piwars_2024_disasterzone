# Folder structure and deployment

## Deployment

We need to deploy a few things:

- Basic setup
- Particular projects behaviours should all be deployed out.
- Board specific setup
    - Deploy any dependancies
    - Select the service that we'd run for it.

Ideally, this would be idempotent. That is - it can be run multiple times without issues, like constantly rebooting the Pi or services unnecessarily.

## Idempotent tools

We've used fabric to keep stuff compatible with all OS's, but we need to know if things have changed.

Tools to consider:
- pip
- raspi-config
- file updates
    - lines in file
    - files synced (the robot folder)
    - files synced - config and env
- apt
- Overrides to force upgrades if things are already installed
- mosquitto password
- systemctl services started
- git clones

Strategies:
1. Switch to ansible - this is the elephant in the room, however, it means windows user MUST go to WSL2 or docker. Trying to avoid this.
2. Create wrapper functions for the tasks.
    - Done right, this could also improve our "host" situation.
    - We could also use this to create a "dry run" mode.
    - This would include idempotency checks
3. Put idempotency checks on each individual operation
    - yuck, would be verbose.
4. Alternatives like chef, saltstack are possible. Both require agents on the Pi I think.
    - "Salt can run without any agent on the target" - agentless mode.
    - is salt stack idempotent - yes
    - can use ssh.
    - Ok - worth investigating. Might be doable in pure python too.
        - Can be called from a python API.
        - Needs "master and minion" - does it need that when used in python?
        - ZMQ setup? Ummm - so much.
        - Standalone/masterless minion. https://docs.saltproject.io/en/3001/topics/tutorials/standalone_minion.html
        - Python api is a client - ahhh. - https://docs.saltproject.io/en/latest/topics/tutorials/quickstart.html

## Project folder structure

Currently, a bit messy. Let's rejig - with service oriented setup.

Forget "src" which is generic, and have "robot".

```
.
├── .github                       # Directory for GitHub services and workflows
├── docs                          # Directory for roadmap and other documentation
│   └── roadmap.md                # File containing rough plans for the project
├── robot                         # Directory for code that runs on the robot
│   ├── services                  # Directory for collection of services that will be available on the robot
│   │   ├── common                # Directory for common code used for setting up a service
│   │   │   └── base_service.py   # File containing the RobotService base class for creating a service
│   │   ├── pimoroni_explorer_hat_pro  # Directory for services related to the Explorer HAT Pro
│   │   │   ├── hardware.py       # File containing the hardware interface code for the Explorer HAT Pro
│   │   │   ├── install.py        # File containing additional fab tasks for setting up the Explorer HAT Pro
│   │   │   └── service.py        # File containing the MQTT client with services offered by the Explorer HAT Pro
│   │   ├── pimoroni_inventor_hat_mini # Directory for services related to the Inventor HAT Mini
│   │   │   ├── hardware.py       # File containing the hardware interface code for the Inventor HAT Mini
│   │   │   ├── install.py        # File containing additional fab tasks for setting up the Inventor HAT Mini
│   │   │   └── service.py        # File containing the MQTT client with services offered by the Inventor HAT Mini
│   │   ├── bno055                # Directory for IMU (Inertial Measurement Unit) services
│   │   └── service_x             # Placeholder directory for additional services
│   ├── tests                     # Directory for collection of tests to run on the robot
│   ├── robot_settings.py         # Tool to read settings for the robot from the .env file
│   └── api.py                    # Deprecated file for interacting with the robot's API
├── fabfile.py                    # File for deployment and setup tasks
├── README.md                     # Main readme file for the project
├── .env_example                  # Example file for creating a .env file with settings for the robot
├── .gitignore                    # File specifying which files should not be tracked by Git
├── CONTRIBUTING.md               # Developer notes and guidelines for contributing to the project
├── LICENSE                       # License file for the repository
├── pyproject.toml                # File specifying the dependencies for managing the project with Poetry
├── poetry.lock                   # Lock file generated by Poetry to ensure consistent dependency resolution
```